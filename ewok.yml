box: tcnksm/gox:1.3.3
build:
  steps:
    - install-packages:
        packages: openssh-client
    - add-ssh-key:
        keyname: REPORTER_KEY
        host: github.com
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: "16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48"
    - termie/glide-build:
        build: false
    - script:
        name: go vet
        code: |-
            go get code.google.com/p/go.tools/cmd/vet
            go vet *.go
    - golint
    - script:
        name: gox
        code: |-
            gox \
              -os="linux darwin" \
              -arch="amd64 386" \
              -output "$WERCKER_OUTPUT_DIR/pkg/{{.OS}}_{{.Arch}}/{{.Dir}}"

    - script:
        name: prepare
        code: |-
            echo $WERCKER_GIT_COMMIT > $WERCKER_OUTPUT_DIR/HEAD
            mv $WERCKER_OUTPUT_DIR/pkg $WERCKER_OUTPUT_DIR/latest
            cp -r $WERCKER_OUTPUT_DIR/latest $WERCKER_OUTPUT_DIR/$WERCKER_GIT_COMMIT

deploy:
  steps:
    - install-packages:
        packages: wget libmagic1 python-dateutil python-magic s3cmd
    - s3sync:
        source-dir: "."
        delete-removed: false
        bucket-url: $AWS_BUCKET_URL/$WERCKER_GIT_BRANCH/
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
